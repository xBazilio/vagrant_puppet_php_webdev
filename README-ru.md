Vargant and puppet PHP web development enviroment
=================================================

vagrant_puppet_php_webdev

# О проекте

Цель проекта - упростить настройку среды разработки веб-пректов. Вместо того, чтобы устанавливать веб сервер, сервер базы данных и php интерпретатор в свою систему, можно установить это всё в виртуальную машину и запускать когда необходимо поработать.

Проект может оказаться полезным для веб студий, когда необходимо распространить единую среду разработки между программистами разного уровня, и не заставлять каждого с нуля всё настраивать и повторять распространённые ошибки.

Всё что нужно, чтобы начать работать, это выполнить:

    vagrant up

Конфигурация vagrant + puppet базируется на примерах [vagrant-examples](https://github.com/patrickdlee/vagrant-examples)

Везде, где видите USER - имеется в виду системное имя вашего пользователя.

# Идея

* Среда разработки развёрнута внутри виртуальной машины
* Использованы [Virtualbox](https://www.virtualbox.org/) и [Vagrant](https://www.vagrantup.com/)
* За основу взят дистрибутив `Debian 7 x64` с предустановленным puppet
* [Puppet](http://puppetlabs.com/) используется для автоматической установки и настройки ПО
* Все насройки выполняются только через puppet, применяются с помощью команды `vagrant reload --provision`
* Файлы веб проектов хранятся в host системе и доступны в guest системе по протоколу NFSv4

# Возможности

* Веб-проекты работают на технологии nginx + php-fpm + mysql
* Можно создавать сайты вида *.loc без необходимости перезапускать веб-сервер
* Все проекты доступны в папке `/home/USER/www`
* Письма, отправленные функцией `mail()` сохраняются в виде .eml файлов в папке `/home/USER/www/EMAILS`
* Для проектов вида \*.loc необходимо создавать структуру папок вида /home/USER/www/\*.loc/web/htdocs, при этом папка htdocs - это DOCUMENT_ROOT
* Можно создавать проекты внутри папки `/home/USER/www` с произвольной конфигурацией. Для этого виртуальные хосты создавать в папке `/home/USER/www/puppet/modules/nginx_vhosts/files/vhosts` и выполнять ```vagrant reload --provision```

# Информация о машине

* IP машины: `192.168.50.10`
* Пароль системного пользователя root: `puppet`
* Пароль Mysql пользователя root: `root`

# Установка

Поместить файлы этого проекта в папку `/home/USER/www`, где USER - имя вашего пользователя. Таким образом файл `Vagrantfile` будет доступен по пути `/home/USER/www/Vagrantfile`.

Для установки vagrant необходимо пройти по ссылке https://www.vagrantup.com/downloads.html и выполнить инструкции.

## Настройка NFS

Встроенная в vagrant общая папка типа nfs не подходит, так как используется протокол NFSv3, при котором заметна медленная работа с файловой системой. Для решения этой проблемы нужно использовать NFSv4.

Для расшаривания папки проекта по NFS необходимо выполнить следующие шаги:

* Установить NFS Kernel Server, если ещё не установлен

    ```sudo apt-get install nfs-kernel-server```

* Создать папку для экпорта

    ```sudo mkdir -p /home/nfs/www```

* Скопировать строку из файла fstab.txt в файл /etc/fstab. Заменить USERNAME на имя пользователя, под которым ведётся работа на Host машине

* Примонтировать папку с проектами

    ```sudo mount -a```

* Скопировать строки из файла exports.txt в файл /etc/exports. Ограничить диапазон IP адресов, если требуется.

* Перезапустить NFS Kernel Server

    ```sudo service nfs-kernel-server restart```

## Установка плагина для Vagrant

Для корректной работы виртуального окружения необходимы актуальные Virtualbox GuestAdditions. Для Vagrant предусмотрен плагин, который автоматически следит за актуальностью версии.

Для установки выполнить:
    vagrant plugin install vagrant-vbguest

## Запуск vagrant

Набраться терпения и выполнить:

    vagrant up

Будет выполнено полное обновление виртуальной системы и установка и настройка всего ПО.

После первого запуска рекомендуется перезагрузить виртуальную машину, чтобы изменения после обновления вступили в силу:

    vagrant reload

Теперь можно быстро выключать машину с помощью:

    vagrant suspend

И быстро включать с помощью:

    vagrant up

# Использование

Покажу на примере. Создадим проект **test.loc**

Для этого создадим папки проекта и PHP файл:

    mkdir -p /home/USER/www/test.loc/web/htdocs
    echo "<?php phpinfo();" > /home/USER/www/test.loc/web/htdocs/info.php

В файл `/etc/hosts` необходимо добавить строку:

    192.168.50.10 test.loc

Проект доступен по адресу http://test.loc

# Tips & tricks

## Подсказки для командной строки

Сохранить файл [vagrant.bash-completion](https://github.com/camptocamp/vagrant-debian-package/blob/master/debian/vagrant.bash-completion) в `/etc/bash_completion.d/vagrant`

## Автоматическая заморозка виртуальных машин

Когда виртуальная машина работает, выключить или перезагрузить компьютер без ошибок не получится. Можно сделать автоматическое сохранение состояния виртуальных машин пользователя при выключении или перезагрузке. Для этого в файл `/etc/default/virtualbox` прописать конфигурацию:

    SHUTDOWN_USERS="USER"
    SHUTDOWN=savestate
